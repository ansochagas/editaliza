<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Principal - Cronograma Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <!-- SCRIPTS CENTRALIZADOS -->
    <script src="js/app.js"></script>
    <script src="js/components.js"></script>
    <script src="js/checklist.js"></script>
    <script src="js/timer.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: all 0.3s ease; }
        .prose { max-width: none; }
        .prose-sm { font-size: 0.875rem; line-height: 1.5; }
        
        /* CORRE√á√ÉO CR√çTICA: Classes CSS faltantes */
        .nav-link-active {
            background-color: #0528f2;
            color: white;
            border-radius: 0.5rem;
        }
        .nav-link-default {
            color: #374151;
        }
        .nav-link-default:hover {
            background-color: #f3f4f6;
            color: #111827;
        }
        .btn-primary {
            background: linear-gradient(135deg, #0528f2, #6366f1);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(5, 40, 242, 0.3);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        .form-input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: white;
            transition: border-color 0.2s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #0528f2;
            box-shadow: 0 0 0 3px rgba(5, 40, 242, 0.1);
        }
        .content-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* CORRE√á√ÉO: Definir vari√°veis CSS faltantes */
        :root {
            --editaliza-blue: #0528f2;
            --editaliza-black: #1f2937;
            --editaliza-gray: #6b7280;
            --editaliza-green: #10b981;
        }
        .text-editaliza-blue { color: var(--editaliza-blue); }
        .text-editaliza-black { color: var(--editaliza-black); }
        .text-editaliza-gray { color: var(--editaliza-gray); }
        .bg-editaliza-blue { background-color: var(--editaliza-blue); }
        .bg-editaliza-black { background-color: var(--editaliza-black); }
        .focus\:ring-editaliza-blue:focus { 
            --tw-ring-color: var(--editaliza-blue); 
            box-shadow: 0 0 0 3px rgba(5, 40, 242, 0.1);
        }
        .bg-editaliza-green { background-color: var(--editaliza-green); }
        .hover\:bg-blue-600:hover { background-color: #2563eb; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .bg-orange-500 { background-color: #f97316; }
        .hover\:bg-orange-600:hover { background-color: #ea580c; }
        
        /* Anima√ß√µes Melhoradas */
        @keyframes pulse-fire {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(5, 40, 242, 0.1); }
            50% { box-shadow: 0 0 30px rgba(5, 40, 242, 0.2); }
        }
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .animate-pulse { animation: pulse-fire 2s infinite ease-in-out; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
        .animate-gradient { 
            background-size: 200% 200%;
            animation: gradient-shift 4s ease infinite;
        }
        
        /* Hero Section Melhorada */
        .hero-gradient {
            background: linear-gradient(135deg, #0528f2, #adeb00, #0528f2);
            background-size: 200% 200%;
        }
        
        /* Cards com Hover Effects */
        .study-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            backdrop-filter: blur(10px);
        }
        .study-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        
        /* Gamification Dashboard Melhorado */
        .stats-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            will-change: transform, box-shadow;
        }
        
        /* Progress Ring */
        .progress-ring {
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        
        /* Motivational Elements */
        .motivation-text {
            background: linear-gradient(45deg, #0528f2, #adeb00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Glass Morphism Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        /* Avatar Styles */
        #userAvatar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }
        #userAvatar:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* User Info Animation */
        #userInfo {
            animation: slideInRight 0.6s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Responsive Improvements */
        @media (max-width: 768px) {
            .study-card:hover {
                transform: translateY(-4px) scale(1.01);
            }
        }
        
        /* Otimiza√ß√µes de Performance */
        .animate-float {
            will-change: transform;
        }
        
        .stats-card {
            will-change: transform;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            will-change: transform, box-shadow;
        }
    </style>
</head>
<body class="min-h-screen text-gray-800 relative overflow-x-hidden">
    <!-- Background Decorative Elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-gradient-to-br from-blue-400/20 to-purple-600/20 rounded-full blur-3xl animate-float"></div>
        <div class="absolute top-40 -left-40 w-60 h-60 bg-gradient-to-br from-green-400/20 to-blue-600/20 rounded-full blur-3xl animate-float" style="animation-delay: 2s;"></div>
        <div class="absolute bottom-40 right-20 w-40 h-40 bg-gradient-to-br from-purple-400/20 to-pink-600/20 rounded-full blur-3xl animate-float" style="animation-delay: 4s;"></div>
    </div>

    <!-- NAVEGA√á√ÉO PRINCIPAL -->
    <div id="main-nav-container"></div>

    <!-- NOVO MODAL DE SESS√ÉO DE ESTUDO -->
    <div id="studySessionModal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-70 z-40 flex items-center justify-center p-4 opacity-0">
        <div id="studySessionModalContainer" class="modal-container bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-2xl transform scale-95 max-h-[90vh] overflow-y-auto">
            <!-- O conte√∫do do modal ser√° injetado aqui pelo JavaScript -->
        </div>
    </div>

    <main class="relative z-10 container mx-auto p-4 sm:p-6 md:p-8 max-w-6xl">
        
        <!-- Hero Header com Informa√ß√µes Destacadas -->
        <div class="glass-card p-8 rounded-3xl mb-8 animate-glow">
            <!-- Se√ß√£o de Boas-vindas com Avatar -->
            <div class="flex flex-col md:flex-row items-center justify-center mb-8">
                <!-- Avatar do Usu√°rio -->
                <div class="mb-6 md:mb-0 md:mr-8">
                    <div class="relative">
                        <img id="userAvatar" 
                             class="w-20 h-20 md:w-24 md:h-24 rounded-full object-cover border-4 border-white shadow-lg animate-float" 
                             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e5e7eb'/%3E%3Ccircle cx='50' cy='35' r='18' fill='%236b7280'/%3E%3Cellipse cx='50' cy='85' rx='30' ry='20' fill='%236b7280'/%3E%3C/svg%3E" 
                             alt="Avatar do usu√°rio"
                             loading="lazy"
                             decoding="async"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'50\' fill=\'%23e5e7eb\'/%3E%3Ccircle cx=\'50\' cy=\'35\' r=\'18\' fill=\'%236b7280\'/%3E%3Cellipse cx=\'50\' cy=\'85\' rx=\'30\' ry=\'20\' fill=\'%236b7280\'/%3E%3C/svg%3E'">
                        <!-- Status Indicator -->
                        <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-gradient-to-br from-green-400 to-green-600 rounded-full border-3 border-white flex items-center justify-center animate-pulse">
                            <span class="text-white text-xs font-bold">‚úì</span>
                        </div>
                    </div>
                </div>
                
                <!-- Informa√ß√µes do Usu√°rio -->
                <div class="text-center">
                    <h1 class="text-4xl md:text-6xl font-bold motivation-text mb-3">
                        <span id="welcomeMessage">Seu Painel de Estudos</span>
                    </h1>
                    <p class="text-gray-600 text-xl mb-6">Transforme seus objetivos em conquistas di√°rias</p>
                </div>
            </div>
            
            <!-- Se√ß√£o Principal de M√©tricas -->
            <div class="text-center mb-8">
                
                <!-- Cards de Informa√ß√µes Importantes -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Data de Hoje -->
                    <div class="stats-card p-6 rounded-2xl bg-gradient-to-br from-blue-100 to-blue-200 border-2 border-blue-300 shadow-lg">
                        <div class="flex items-center justify-center mb-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-sm font-semibold text-blue-800 uppercase tracking-wider mb-1">Hoje</p>
                        <p id="todayDateHero" class="text-lg font-bold text-blue-900">--</p>
                    </div>
                    
                    <!-- Dias para a Prova -->
                    <div class="stats-card p-6 rounded-2xl bg-gradient-to-br from-red-100 to-red-200 border-2 border-red-300 shadow-lg">
                        <div class="flex items-center justify-center mb-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center animate-pulse">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-sm font-semibold text-red-800 uppercase tracking-wider mb-1">Dias para Prova</p>
                        <p id="daysToExamHero" class="text-2xl font-bold text-red-900">--</p>
                    </div>
                    
                    <!-- Progresso Geral -->
                    <div class="stats-card p-6 rounded-2xl bg-gradient-to-br from-green-100 to-green-200 border-2 border-green-300 shadow-lg">
                        <div class="flex items-center justify-center mb-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-sm font-semibold text-green-800 uppercase tracking-wider mb-1">Progresso</p>
                        <p id="generalProgressHero" class="text-lg font-bold text-green-900">--%</p>
                    </div>
                </div>
            </div>
            
            <!-- Seletor de Plano -->
            <header id="plan-selector-header" class="stats-card p-6 rounded-2xl bg-gradient-to-br from-purple-100 to-purple-200 border-2 border-purple-300 shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                    <div class="mb-4 sm:mb-0">
                        <label for="planSelector" class="text-sm font-semibold text-purple-800 uppercase tracking-wider">Plano de Estudo Ativo:</label>
                        <select id="planSelector" class="mt-2 block w-full sm:w-auto rounded-xl border-2 border-purple-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 bg-white px-4 py-3 text-gray-800 font-medium transition-all duration-300"></select>
                    </div>
                    <div id="plan-links-container" class="flex items-center space-x-3"></div>
                </div>
            </header>
        </div>

        <!-- ‚≠ê SE√á√ÉO PRIORIT√ÅRIA: Atividades do Dia (MOVIDA AINDA MAIS PARA CIMA) -->
        <div class="mb-6 -mt-4">
            <!-- Header das Atividades (Design Melhorado) -->
            <div class="glass-card p-8 rounded-3xl mb-6 border-l-4 border-blue-500 animate-glow">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-3xl flex items-center justify-center animate-float shadow-2xl">
                                <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <h2 class="text-4xl font-bold motivation-text mb-2">üìö Suas Atividades de Hoje</h2>
                            <p id="todayDate" class="text-xl text-gray-600 font-semibold"></p>
                            <p class="text-base text-gray-500 mt-2">üéØ Foque nestas tarefas para alcan√ßar seus objetivos!</p>
                        </div>
                    </div>
                    <!-- Indicador de urg√™ncia melhorado -->
                    <div class="text-right">
                        <div class="flex flex-col items-end space-y-2">
                            <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-bold bg-gradient-to-r from-orange-500 to-red-500 text-white animate-pulse shadow-lg">
                                <span class="w-3 h-3 bg-white rounded-full mr-2 animate-ping"></span>
                                ‚ö° M√ÅXIMA PRIORIDADE
                            </div>
                            <p class="text-xs text-gray-500 italic">Comece por aqui!</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Container das Atividades -->
            <div id="todaySchedule"></div>
        </div>

        <!-- Alertas importantes -->
        <div id="overdue-alert-container"></div>

        <!-- Dashboard de Gamifica√ß√£o (sem duplicatas) -->
        <div id="gamification-dashboard"></div>
    </main>

    <script>
        let todaySessionsData = [];
        
        async function loadUserProfile() {
            try {
                const profile = await app.apiFetch("/profile");
                const welcomeElement = document.getElementById("welcomeMessage");
                const userAvatarElement = document.getElementById("userAvatar");
                
                if (profile && profile.name) {
                    welcomeElement.textContent = "Bem-vindo(a), " + app.sanitizeHtml(profile.name) + "!";
                    
                    // Atualizar avatar - usando a mesma l√≥gica da profile.html
                    if (userAvatarElement) {
                        if (profile.profile_picture && profile.profile_picture.trim() !== '') {
                            // Add cache buster to avoid caching issues (mesma l√≥gica da profile.html)
                            const cacheBuster = '?t=' + new Date().getTime();
                            const avatarPath = profile.profile_picture.startsWith('./') ? 
                                profile.profile_picture + cacheBuster : 
                                './' + profile.profile_picture + cacheBuster;
                            
                            userAvatarElement.src = avatarPath;
                            userAvatarElement.alt = "Avatar de " + app.sanitizeHtml(profile.name);
                            
                            // Handle load error (mesma l√≥gica da profile.html)
                            userAvatarElement.addEventListener('error', () => {
                                console.error('‚ùå Erro ao carregar avatar:', avatarPath);
                                // Fallback para avatar padr√£o
                                userAvatarElement.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e5e7eb'/%3E%3Ccircle cx='50' cy='35' r='18' fill='%236b7280'/%3E%3Cellipse cx='50' cy='85' rx='30' ry='20' fill='%236b7280'/%3E%3C/svg%3E";
                                userAvatarElement.alt = "Avatar padr√£o";
                            }, { once: true });
                            
                            // Handle load success
                            userAvatarElement.addEventListener('load', () => {
                                console.log('‚úÖ Avatar carregado com sucesso:', avatarPath);
                            }, { once: true });
                        } else {
                            // Avatar padr√£o quando n√£o h√° profile_picture
                            userAvatarElement.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e5e7eb'/%3E%3Ccircle cx='50' cy='35' r='18' fill='%236b7280'/%3E%3Cellipse cx='50' cy='85' rx='30' ry='20' fill='%236b7280'/%3E%3C/svg%3E";
                            userAvatarElement.alt = "Avatar padr√£o";
                        }
                    }
                } else {
                    welcomeElement.textContent = "Seu Painel de Estudos";
                    
                    // Avatar padr√£o para usu√°rio sem nome
                    if (userAvatarElement) {
                        userAvatarElement.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e5e7eb'/%3E%3Ccircle cx='50' cy='35' r='18' fill='%236b7280'/%3E%3Cellipse cx='50' cy='85' rx='30' ry='20' fill='%236b7280'/%3E%3C/svg%3E";
                        userAvatarElement.alt = "Avatar padr√£o";
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                const welcomeElement = document.getElementById("welcomeMessage");
                if (welcomeElement) {
                    welcomeElement.textContent = "Seu Painel de Estudos";
                }
                
                const userAvatarElement = document.getElementById("userAvatar");
                if (userAvatarElement) {
                    userAvatarElement.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e5e7eb'/%3E%3Ccircle cx='50' cy='35' r='18' fill='%236b7280'/%3E%3Cellipse cx='50' cy='85' rx='30' ry='20' fill='%236b7280'/%3E%3C/svg%3E";
                    userAvatarElement.alt = "Avatar padr√£o";
                }
            }
        }
        
        async function initialize() {
            console.log('üöÄ Inicializando p√°gina home...');
            
            // CORRE√á√ÉO CR√çTICA: Garantir que os componentes UI globais existam
            try {
                if (!document.getElementById('toast-container')) {
                    components.renderGlobalUI();
                }
            } catch (error) {
                console.warn('Erro ao renderizar UI global:', error);
            }
            
            try {
                await components.renderMainNavigation('home.html');
                
                // Configurar datas
                const today = new Date();
                const formattedDate = today.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });
                
                const todayDateEl = document.getElementById('todayDate');
                const todayDateHeroEl = document.getElementById('todayDateHero');
                
                if (todayDateEl) todayDateEl.textContent = formattedDate;
                if (todayDateHeroEl) todayDateHeroEl.textContent = formattedDate;
                
                app.showSpinner();
                
                // Carregar perfil do usu√°rio
                try {
                    await loadUserProfile();
                } catch (error) {
                    console.warn('Erro ao carregar perfil:', error);
                    // Continuar mesmo se o perfil falhar
                }
                
                // Carregar planos
                console.log('üìã Carregando planos do usu√°rio...');
                const plans = await app.getPlans();
                console.log(`‚úÖ ${plans?.length || 0} planos encontrados`);

                // CORRE√á√ÉO CR√çTICA: Valida√ß√£o mais robusta e UI clara para novos usu√°rios
                const planSelectorHeader = document.getElementById('plan-selector-header');
                const todayScheduleEl = document.getElementById('todaySchedule');
                
                if (!plans || plans.length === 0) {
                    console.log('üë§ Usu√°rio novo detectado - exibindo tela de boas-vindas');
                    
                    const planSelectorContainer = planSelectorHeader.closest('.stats-card');
                    if (planSelectorContainer) {
                        planSelectorContainer.innerHTML = `
                            <div class="text-center p-8 bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl border-2 border-dashed border-blue-300">
                                <div class="mb-6">
                                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                                        <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-2">üéØ Come√ße sua Jornada!</h3>
                                    <p class="text-gray-600 mb-6">Crie seu primeiro plano de estudos e comece a organizar seus estudos de forma inteligente.</p>
                                    <a href="dashboard.html" id="create-first-plan-btn" class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg">
                                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                                        </svg>
                                        Criar Meu Primeiro Plano
                                    </a>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Limpar √°rea de cronograma para usu√°rios novos
                    if (todayScheduleEl) {
                        todayScheduleEl.innerHTML = `
                            <div class="text-center stats-card p-12 rounded-3xl">
                                <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-3xl flex items-center justify-center mx-auto mb-6 animate-bounce">
                                    <span class="text-6xl">üåü</span>
                                </div>
                                <h3 class="text-3xl font-bold motivation-text mb-3">Bem-vindo(a)!</h3>
                                <p class="text-xl text-gray-600 mb-4">Seu cronograma aparecer√° aqui ap√≥s criar seu primeiro plano</p>
                                <p class="text-gray-500">Clique no bot√£o acima para come√ßar</p>
                            </div>
                        `;
                    }
                    
                    console.log('‚úÖ Tela de boas-vindas configurada');
                    return; // Para a execu√ß√£o aqui para usu√°rios sem planos
                }
                
                // CORRE√á√ÉO: Valida√ß√£o do seletor de planos
                const planSelector = document.getElementById('planSelector');
                if (!planSelector) {
                    throw new Error('Elemento planSelector n√£o encontrado no DOM');
                }
                
                // Se chegou aqui, significa que existem planos. Continua o carregamento normal.
                console.log('üìù Populando seletor de planos...');
                planSelector.innerHTML = plans.map(p => `<option value="${p.id}">${app.sanitizeHtml(p.plan_name)}</option>`).join('');
                
                // Restaurar √∫ltimo plano selecionado
                const lastSelectedPlanId = localStorage.getItem('selectedPlanId');
                if (lastSelectedPlanId && plans.some(p => p.id == lastSelectedPlanId)) {
                    planSelector.value = lastSelectedPlanId;
                    console.log(`üîÑ Restaurado plano: ${lastSelectedPlanId}`);
                }
                
                // Carregar dados do plano selecionado
                console.log('üìä Carregando dados do plano...');
                await loadDataForSelectedPlan();
                
                // Adicionar listener para mudan√ßa de plano
                planSelector.addEventListener('change', loadDataForSelectedPlan);
                console.log('‚úÖ Inicializa√ß√£o completa!');

            } catch(error) {
                console.error("‚ùå Erro na inicializa√ß√£o da p√°gina home:", error);
                
                // CORRE√á√ÉO: UI de erro mais informativa
                const todayScheduleEl = document.getElementById('todaySchedule');
                if (todayScheduleEl) {
                    todayScheduleEl.innerHTML = `
                        <div class="text-center stats-card p-12 rounded-3xl border-2 border-red-200">
                            <div class="w-24 h-24 bg-gradient-to-br from-red-500 to-pink-600 rounded-3xl flex items-center justify-center mx-auto mb-6">
                                <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-3">‚ö†Ô∏è Erro ao Carregar</h3>
                            <p class="text-gray-600 mb-6">N√£o foi poss√≠vel carregar seus dados. Verifique sua conex√£o.</p>
                            <div class="space-y-3">
                                <button onclick="location.reload()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all duration-300">
                                    üîÑ Tentar Novamente
                                </button>
                                <p class="text-sm text-gray-500">Erro: ${app.sanitizeHtml(error.message)}</p>
                            </div>
                        </div>
                    `;
                }
                
                app.showToast('Erro ao carregar dados: ' + error.message, 'error');
            } finally {
                app.hideSpinner();
            }
        }

        async function loadDataForSelectedPlan() {
            const planSelector = document.getElementById('planSelector');
            if (!planSelector) {
                console.log('‚ö†Ô∏è  planSelector n√£o encontrado - usu√°rio provavelmente novo');
                return;
            }
            
            const planId = planSelector.value;
            if (!planId) {
                console.log('‚ö†Ô∏è  Nenhum plano selecionado');
                return;
            }
            if (window.loadingPlanData) return;
            window.loadingPlanData = true;
            app.showSpinner();
            localStorage.setItem('selectedPlanId', planId);
            app.state.activePlanId = planId;
            const planLinksContainer = document.getElementById('plan-links-container');
            planLinksContainer.innerHTML = `
                <a href="plan.html?id=${planId}" class="group px-6 py-3 text-sm font-semibold rounded-xl bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 text-blue-700 border border-blue-200 transition-all duration-300 transform hover:scale-105 hover:shadow-lg flex items-center space-x-2">
                    <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Meu Desempenho</span>
                </a>
                <a href="cronograma.html?id=${planId}" class="group px-6 py-3 text-sm font-semibold rounded-xl bg-gradient-to-r from-green-50 to-emerald-50 hover:from-green-100 hover:to-emerald-100 text-green-700 border border-green-200 transition-all duration-300 transform hover:scale-105 hover:shadow-lg flex items-center space-x-2">
                    <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Ver Cronograma</span>
                </a>
                <a href="plan_settings.html?id=${planId}" class="group px-6 py-3 text-sm font-semibold rounded-xl bg-gradient-to-r from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 text-purple-700 border border-purple-200 transition-all duration-300 transform hover:scale-105 hover:shadow-lg flex items-center space-x-2">
                    <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Configurar Plano</span>
                </a>
                <button onclick="shareProgress()" class="group px-6 py-3 text-sm font-semibold rounded-xl bg-gradient-to-r from-orange-50 to-yellow-50 hover:from-orange-100 hover:to-yellow-100 text-orange-700 border border-orange-200 transition-all duration-300 transform hover:scale-105 hover:shadow-lg flex items-center space-x-2">
                    <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path>
                    </svg>
                    <span>Compartilhar Progresso</span>
                </button>
            `;
            try {
                await Promise.all([
                    loadTodaySchedule(),
                    checkForOverdueTasks(),
                    loadGamificationData()
                ]);
            } catch (error) {
                app.showToast('Erro ao carregar dados do plano.', 'error');
            } finally {
                window.loadingPlanData = false;
                app.hideSpinner();
            }
        }

        // CORRE√á√ÉO: Fun√ß√£o melhorada para carregar m√©tricas precisas
        async function loadGamificationData() {
            try {
                console.log('üìà Carregando dados de gamifica√ß√£o...');
                
                // Validar se activePlanId est√° dispon√≠vel antes de fazer a requisi√ß√£o
                if (!app.state.activePlanId) {
                    console.warn('‚ö†Ô∏è loadGamificationData: activePlanId n√£o est√° dispon√≠vel ainda');
                    return;
                }
                
                // Carregar dados de gamifica√ß√£o com valida√ß√£o
                const gamificationData = await app.getGamificationData(app.state.activePlanId);
                console.log('üìã Dados de gamifica√ß√£o recebidos:', gamificationData);
                
                // Renderizar dashboard principal
                components.renderGamificationDashboard(gamificationData, 'gamification-dashboard');
                
                // CORRE√á√ÉO: Atualizar m√©tricas do hero com dados reais e valida√ß√£o
                try {
                    const plan = await app.apiFetch(`/plans/${app.state.activePlanId}`);
                    
                    // C√°lculo correto dos dias para a prova
                    if (plan.exam_date) {
                        const examDate = new Date(plan.exam_date + 'T00:00:00');
                        const today = new Date();
                        today.setHours(0, 0, 0, 0); // Zerar horas para c√°lculo preciso
                        const timeDiff = examDate.getTime() - today.getTime();
                        const daysToExam = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        
                        const daysToExamHeroElement = document.getElementById('daysToExamHero');
                        if (daysToExamHeroElement) {
                            daysToExamHeroElement.textContent = daysToExam > 0 ? `${daysToExam}` : '0';
                            // Adicionar cor baseada na urg√™ncia
                            if (daysToExam <= 30) {
                                daysToExamHeroElement.classList.add('text-red-600', 'animate-pulse');
                            } else if (daysToExam <= 90) {
                                daysToExamHeroElement.classList.add('text-orange-600');
                            } else {
                                daysToExamHeroElement.classList.add('text-green-600');
                            }
                        }
                        console.log(`üìÖ Dias para a prova calculados: ${daysToExam}`);
                    }
                    
                    // C√°lculo correto do progresso geral
                    const progressData = await app.getActivePlanData(app.state.activePlanId, 'detailed_progress', true);
                    let progressPercentage = 0;
                    
                    if (progressData && typeof progressData.totalProgress === 'number') {
                        progressPercentage = Math.round(progressData.totalProgress);
                    } else if (gamificationData && gamificationData.completedTopicsCount) {
                        // Fallback: calcular com base nos t√≥picos conclu√≠dos
                        const totalTopics = gamificationData.totalTopicsCount || 100; // Assumir 100 se n√£o especificado
                        progressPercentage = Math.round((gamificationData.completedTopicsCount / totalTopics) * 100);
                    }
                    
                    const generalProgressHeroElement = document.getElementById('generalProgressHero');
                    if (generalProgressHeroElement) {
                        generalProgressHeroElement.textContent = `${Math.min(progressPercentage, 100)}%`;
                        // Adicionar anima√ß√£o baseada no progresso
                        if (progressPercentage >= 80) {
                            generalProgressHeroElement.classList.add('text-green-600', 'animate-bounce');
                        } else if (progressPercentage >= 50) {
                            generalProgressHeroElement.classList.add('text-blue-600');
                        } else {
                            generalProgressHeroElement.classList.add('text-orange-600');
                        }
                    }
                    
                    console.log(`üìà Progresso geral calculado: ${progressPercentage}%`);
                    console.log('‚úÖ M√©tricas atualizadas com sucesso!');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao calcular m√©tricas do plano:', error);
                    // Valores padr√£o em caso de erro
                    const daysToExamHeroElement = document.getElementById('daysToExamHero');
                    const generalProgressHeroElement = document.getElementById('generalProgressHero');
                    
                    if (daysToExamHeroElement) daysToExamHeroElement.textContent = '--';
                    if (generalProgressHeroElement) generalProgressHeroElement.textContent = '--%';
                }
            } catch (error) {
                console.error("‚ùå Erro ao carregar dados de gamifica√ß√£o:", error);
                // Exibir mensagem de erro amig√°vel
                const gamificationContainer = document.getElementById('gamification-dashboard');
                if (gamificationContainer) {
                    gamificationContainer.innerHTML = `
                        <div class="stats-card p-8 rounded-2xl text-center bg-gradient-to-br from-yellow-100 to-orange-200 border-2 border-yellow-300 shadow-lg">
                            <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">‚ö†Ô∏è</span>
                            </div>
                            <h3 class="text-lg font-semibold text-yellow-800 mb-2">Erro ao Carregar Estat√≠sticas</h3>
                            <p class="text-yellow-700 text-sm">Tente recarregar a p√°gina</p>
                        </div>
                    `;
                }
            }
        }
        
        async function checkForOverdueTasks() {
            try {
                if (!app.state.activePlanId) {
                    console.warn('‚ùå activePlanId n√£o definido para verificar tarefas atrasadas');
                    return;
                }
                const overdueData = await app.apiFetch(`/plans/${app.state.activePlanId}/overdue_check`);
                if (overdueData.count > 0) {
                    components.renderOverdueAlert(overdueData.count);
                    addReplanListener();
                } else {
                    const container = document.getElementById('overdue-alert-container');
                    if (container) container.innerHTML = '';
                }
            } catch (error) {
                console.warn('Erro ao verificar tarefas atrasadas:', error);
                // N√£o mostrar toast para erros de API opcionales
            }
        }

        function addReplanListener() {
            const replanButton = document.getElementById('replanButton');
            const showDetailsButton = document.getElementById('showReplanDetailsButton');
            
            // Listener para mostrar detalhes do replanejamento
            if (showDetailsButton) {
                showDetailsButton.addEventListener('click', async () => {
                    const detailsSection = document.getElementById('replanDetails');
                    const detailsContent = document.getElementById('replanDetailsContent');
                    
                    if (detailsSection.classList.contains('hidden')) {
                        // Mostrar detalhes
                        detailsSection.classList.remove('hidden');
                        showDetailsButton.innerHTML = `
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Ocultar Detalhes</span>
                        `;
                        
                        // Carregar dados do preview
                        try {
                            if (!app.state.activePlanId) {
                                console.warn('‚ùå activePlanId n√£o definido para carregar preview');
                                return;
                            }
                            const previewData = await app.apiFetch(`/plans/${app.state.activePlanId}/replan-preview`);
                            
                            if (previewData.hasOverdue) {
                                let detailsHtml = `
                                    <div class="mb-4">
                                        <h5 class="font-semibold text-blue-800 mb-2">üìã ${previewData.strategy}</h5>
                                        <p class="text-blue-700 mb-3">${previewData.description}</p>
                                        
                                        <div class="bg-white/60 rounded-lg p-3 mb-3">
                                            <div class="flex items-center justify-between text-sm">
                                                <span>üìä Total a replanejar: <strong>${previewData.count} atividades</strong></span>
                                                <span>‚è∞ Dias at√© prova: <strong>${previewData.daysUntilExam} dias</strong></span>
                                            </div>
                                        </div>
                                `;
                                
                                if (previewData.replanPreview && previewData.replanPreview.length > 0) {
                                    detailsHtml += `
                                        <h6 class="font-medium text-blue-800 mb-2">üîÑ Primeiras atividades a serem realocadas:</h6>
                                        <div class="space-y-2">
                                    `;
                                    
                                    previewData.replanPreview.forEach((item, index) => {
                                        detailsHtml += `
                                            <div class="bg-white/80 rounded-lg p-3 border-l-2 border-blue-300">
                                                <div class="flex items-start justify-between">
                                                    <div class="flex-1">
                                                        <div class="font-medium text-gray-800">${item.subject} - ${item.sessionType}</div>
                                                        <div class="text-sm text-gray-600 truncate">${item.topic}</div>
                                                    </div>
                                                    <div class="text-right ml-3">
                                                        <div class="text-xs text-red-600">De: ${new Date(item.originalDate).toLocaleDateString('pt-BR')}</div>
                                                        <div class="text-xs text-green-600 font-medium">Para: ${item.newDateFormatted}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    });
                                    
                                    detailsHtml += `</div>`;
                                    
                                    if (previewData.totalToReplan > previewData.replanPreview.length) {
                                        detailsHtml += `
                                            <div class="mt-3 text-center">
                                                <span class="text-sm text-blue-600 bg-blue-100 px-3 py-1 rounded-full">
                                                    +${previewData.totalToReplan - previewData.replanPreview.length} mais atividades
                                                </span>
                                            </div>
                                        `;
                                    }
                                }
                                
                                detailsHtml += `</div>`;
                                detailsContent.innerHTML = detailsHtml;
                            } else {
                                detailsContent.innerHTML = `
                                    <div class="text-center">
                                        <span class="text-green-600">‚úÖ Nenhuma tarefa atrasada encontrada!</span>
                                    </div>
                                `;
                            }
                        } catch (error) {
                            detailsContent.innerHTML = `
                                <div class="text-red-600">
                                    ‚ùå Erro ao carregar detalhes: ${error.message}
                                </div>
                            `;
                        }
                    } else {
                        // Ocultar detalhes
                        detailsSection.classList.add('hidden');
                        showDetailsButton.innerHTML = `
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Ver Detalhes</span>
                        `;
                    }
                });
            }
            
            // Listener para replanejar
            if(replanButton) {
                replanButton.addEventListener('click', async () => {
                    if (!app.state.activePlanId) {
                        app.showToast('Nenhum plano ativo selecionado', 'error');
                        return;
                    }
                    app.showSpinner();
                    try {
                        const data = await app.apiFetch(`/plans/${app.state.activePlanId}/replan`, { method: 'POST' });
                        app.showToast(data.message, 'success');
                        await loadTodaySchedule();
                        document.getElementById('overdue-alert-container').innerHTML = '';
                    } catch (error) {
                        app.showToast(error.message, 'error');
                    } finally {
                        app.hideSpinner();
                    }
                });
            }
        }

        async function loadTodaySchedule() {
            const container = document.getElementById('todaySchedule');
            const todayStr = new Date().toISOString().split('T')[0];
            try {
                // Validar se activePlanId est√° dispon√≠vel antes de fazer a requisi√ß√£o
                if (!app.state.activePlanId) {
                    console.warn('‚ö†Ô∏è loadTodaySchedule: activePlanId n√£o est√° dispon√≠vel ainda');
                    return;
                }
                
                const fullSchedule = await app.getActivePlanData(app.state.activePlanId, 'schedule', true); 
                todaySessionsData = fullSchedule[todayStr] || [];
                if (todaySessionsData.length === 0) {
                    container.innerHTML = `
                        <div class="text-center stats-card p-12 rounded-3xl animate-float">
                            <div class="w-24 h-24 bg-gradient-to-br from-green-500 to-emerald-600 rounded-3xl flex items-center justify-center mx-auto mb-6 animate-pulse">
                                <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <h3 class="text-3xl font-bold motivation-text mb-3">Dia Livre!</h3>
                            <p class="text-xl text-gray-600 mb-4">Nenhuma tarefa agendada para hoje</p>
                            <p class="text-gray-500">Aproveite para descansar ou revisar conte√∫dos anteriores</p>
                            <div class="mt-6 flex justify-center space-x-2">
                                <span class="text-4xl animate-bounce">üéâ</span>
                                <span class="text-4xl animate-bounce" style="animation-delay: 0.1s;">üåü</span>
                                <span class="text-4xl animate-bounce" style="animation-delay: 0.2s;">‚ú®</span>
                            </div>
                        </div>`;
                    return;
                }
                const allTasksCompleted = todaySessionsData.every(session => session.status === 'Conclu√≠do');
                if (allTasksCompleted) {
                    container.innerHTML = `
                        <div class="text-center stats-card p-12 rounded-3xl animate-glow">
                            <div class="w-32 h-32 bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse">
                                <span class="text-6xl animate-bounce">üöÄ</span>
                            </div>
                            <h3 class="text-4xl font-bold motivation-text mb-4">MISS√ÉO CUMPRIDA!</h3>
                            <p class="text-xl text-gray-700 font-semibold mb-2">Voc√™ dominou o dia completo!</p>
                            <p class="text-gray-600 mb-6">Que tal um merecido descanso agora?</p>
                            <div class="flex justify-center space-x-3 mb-6">
                                <span class="text-3xl animate-bounce">üéØ</span>
                                <span class="text-3xl animate-bounce" style="animation-delay: 0.1s;">üí™</span>
                                <span class="text-3xl animate-bounce" style="animation-delay: 0.2s;">üèÜ</span>
                                <span class="text-3xl animate-bounce" style="animation-delay: 0.3s;">‚≠ê</span>
                            </div>
                            <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-2xl p-4">
                                <p class="text-sm text-gray-600 font-medium">Parab√©ns! Sua dedica√ß√£o √© inspiradora! üíö</p>
                            </div>
                        </div>`;
                    await loadGamificationData(); 
                    return;
                }
                const sessionsHtml = todaySessionsData.map(session => renderIndividualCard(session)).join('');
                const completedCount = todaySessionsData.filter(s => s.status === 'Conclu√≠do').length;
                const totalCount = todaySessionsData.length;
                const progressPercentage = Math.round((completedCount / totalCount) * 100);
                
                // CORRE√á√ÉO: Mensagens motivacionais mais espec√≠ficas e variadas
                let motivationText = "Continue assim! üí™";
                let motivationIcon = "üí™";
                
                if (progressPercentage === 0) {
                    motivationText = "Vamos come√ßar esta jornada! üéÜ";
                    motivationIcon = "üéÜ";
                } else if (progressPercentage < 20) {
                    motivationText = "Primeiros passos dados! üöÄ";
                    motivationIcon = "üöÄ";
                } else if (progressPercentage < 40) {
                    motivationText = "Ritmo consistente! Continue! üéØ";
                    motivationIcon = "üéØ";
                } else if (progressPercentage < 60) {
                    motivationText = "Voc√™ est√° no caminho certo! üåü";
                    motivationIcon = "üåü";
                } else if (progressPercentage < 80) {
                    motivationText = "Excelente progresso! üí™";
                    motivationIcon = "üí™";
                } else if (progressPercentage < 100) {
                    motivationText = "Reta final! Voc√™ consegue! üî•";
                    motivationIcon = "üî•";
                } else {
                    motivationText = "DIA PERFEITO! Parab√©ns! üèÜ";
                    motivationIcon = "üèÜ";
                }
                
                container.innerHTML = `
                    <!-- Progress Overview -->
                    <div class="stats-card p-6 rounded-2xl mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Progresso do Dia</h3>
                                <p class="text-sm text-gray-600">${completedCount} de ${totalCount} tarefas conclu√≠das</p>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold motivation-text">${progressPercentage}%</div>
                                <div class="text-sm text-gray-500">Completo</div>
                            </div>
                        </div>
                        <div class="w-full bg-gradient-to-r from-gray-100 to-gray-200 rounded-full h-3 overflow-hidden border border-gray-300">
                            <div class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-1000 ease-out animate-gradient" 
                                 style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xs text-gray-500">In√≠cio</span>
                            <span class="text-xs font-medium text-gray-700 flex items-center">
                                <span class="mr-2">${motivationIcon}</span>
                                <span>${motivationText}</span>
                            </span>
                            <span class="text-xs text-gray-500">Meta</span>
                        </div>
                    </div>
                    
                    <!-- Study Sessions Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${sessionsHtml}
                    </div>`;
            } catch (error) {
                container.innerHTML = `
                    <div class="text-center stats-card p-12 rounded-3xl">
                        <div class="w-24 h-24 bg-gradient-to-br from-red-500 to-pink-600 rounded-3xl flex items-center justify-center mx-auto mb-6">
                            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-3">Ops! Algo deu errado</h3>
                        <p class="text-gray-600 mb-6">N√£o foi poss√≠vel carregar seu plano de estudos</p>
                        <button onclick="location.reload()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all duration-300">
                            Tentar Novamente
                        </button>
                    </div>`;
                app.showToast(error.message, 'error');
            }
        }

        function renderIndividualCard(session) {
            switch (session.session_type) {
                case 'Novo T√≥pico': case 'Refor√ßo Extra': case 'Revis√£o 7D': case 'Revis√£o 14D': case 'Revis√£o 28D':
                    return components.createSessionCard(session);
                case 'Simulado Direcionado': case 'Simulado Completo':
                    return components.createSimuladCard(session);
                case 'Reda√ß√£o':
                    return components.createEssayCard(session);
                default:
                    return components.createSessionCard(session);
            }
        }
        
        // CORRE√á√ÉO CR√çTICA: Fun√ß√£o global para abrir sess√µes de estudo
        function openStudySession(sessionId) {
            // Buscar o objeto da sess√£o no array de dados
            const session = todaySessionsData.find(s => s.id == sessionId);
            if (session) {
                StudyChecklist.show(session);
            } else {
                app.showToast('Erro: Sess√£o n√£o encontrada. Recarregue a p√°gina e tente novamente.', 'error');
            }
        }
        
        // Fun√ß√£o para compartilhar progresso
        async function shareProgress() {
            const planId = app.state.activePlanId;
            if (!planId) {
                app.showToast('Nenhum plano selecionado', 'error');
                return;
            }
            
            try {
                app.showSpinner();
                const shareData = await app.apiFetch(`/plans/${planId}/share-progress`);
                
                // Verificar se o navegador suporta Web Share API
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: `Meu Progresso - ${shareData.planName}`,
                            text: shareData.shareText
                        });
                        app.showToast('Progresso compartilhado com sucesso!', 'success');
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            // Se o Web Share falhar, usar fallback
                            fallbackShare(shareData);
                        }
                    }
                } else {
                    // Fallback para navegadores que n√£o suportam Web Share API
                    fallbackShare(shareData);
                }
            } catch (error) {
                app.showToast(`Erro ao gerar dados de compartilhamento: ${error.message}`, 'error');
            } finally {
                app.hideSpinner();
            }
        }
        
        // Fallback para compartilhamento em navegadores sem Web Share API
        function fallbackShare(shareData) {
            // Criar modal de compartilhamento
            const modalHtml = `
                <div id="shareModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
                    <div class="modal-container bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md transform">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">Compartilhar Progresso</h3>
                            <p class="text-gray-600">Mostre seu progresso para amigos e fam√≠lia!</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 mb-6 border border-blue-200">
                            <textarea id="shareText" readonly class="w-full h-32 bg-transparent border-none resize-none text-sm text-gray-700 focus:outline-none">${shareData.shareText}</textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <button onclick="copyToClipboard()" class="flex items-center justify-center px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
                                </svg>
                                Copiar Texto
                            </button>
                            <button onclick="shareToWhatsApp(document.getElementById('shareText').value)" class="flex items-center justify-center px-4 py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"></path>
                                </svg>
                                WhatsApp
                            </button>
                        </div>
                        
                        <button onclick="closeShareModal()" class="w-full px-6 py-3 bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg">
                            Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Fun√ß√£o para copiar texto para clipboard
        function copyToClipboard() {
            const shareText = document.getElementById('shareText');
            shareText.select();
            shareText.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                app.showToast('Texto copiado para a √°rea de transfer√™ncia!', 'success');
                closeShareModal();
            } catch (error) {
                app.showToast('Erro ao copiar texto', 'error');
            }
        }
        
        // Fun√ß√£o para compartilhar no WhatsApp
        function shareToWhatsApp(text) {
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(whatsappUrl, '_blank');
            closeShareModal();
        }
        
        // Fun√ß√£o para fechar modal de compartilhamento
        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Fun√ß√£o para sincronizar avatar quando atualizado no perfil
        async function syncUserAvatar() {
            try {
                const userAvatarElement = document.getElementById("userAvatar");
                if (!userAvatarElement) return;
                
                const profile = await app.apiFetch("/profile");
                if (profile && profile.profile_picture && profile.profile_picture.trim() !== '') {
                    // Add cache buster to avoid caching issues (mesma l√≥gica da profile.html)
                    const cacheBuster = '?t=' + new Date().getTime();
                    const avatarPath = profile.profile_picture.startsWith('./') ? 
                        profile.profile_picture + cacheBuster : 
                        './' + profile.profile_picture + cacheBuster;
                    
                    userAvatarElement.src = avatarPath;
                    userAvatarElement.alt = "Avatar de " + app.sanitizeHtml(profile.name || 'usu√°rio');
                    
                    // Handle load error
                    userAvatarElement.addEventListener('error', () => {
                        console.error('‚ùå Erro ao carregar avatar:', avatarPath);
                        // Fallback para avatar padr√£o
                        userAvatarElement.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e5e7eb'/%3E%3Ccircle cx='50' cy='35' r='18' fill='%236b7280'/%3E%3Cellipse cx='50' cy='85' rx='30' ry='20' fill='%236b7280'/%3E%3C/svg%3E";
                        userAvatarElement.alt = "Avatar padr√£o";
                    }, { once: true });
                    
                    // Handle load success
                    userAvatarElement.addEventListener('load', () => {
                        console.log('‚úÖ Avatar sincronizado com sucesso:', avatarPath);
                    }, { once: true });
                } else {
                    // Avatar padr√£o quando n√£o h√° profile_picture
                    userAvatarElement.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e5e7eb'/%3E%3Ccircle cx='50' cy='35' r='18' fill='%236b7280'/%3E%3Cellipse cx='50' cy='85' rx='30' ry='20' fill='%236b7280'/%3E%3C/svg%3E";
                    userAvatarElement.alt = "Avatar padr√£o";
                }
            } catch (error) {
                console.error('Erro ao sincronizar avatar:', error);
            }
        }
        
        // Tornar fun√ß√µes globais acess√≠veis
        window.openStudySession = openStudySession;
        window.shareProgress = shareProgress;
        window.copyToClipboard = copyToClipboard;
        window.shareToWhatsApp = shareToWhatsApp;
        window.closeShareModal = closeShareModal;
        window.syncUserAvatar = syncUserAvatar;
        
        // Adicionar listener para sincronizar avatar quando a p√°gina voltar a ter foco
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // P√°gina voltou a ter foco, sincronizar avatar
                syncUserAvatar();
            }
        });
        
        document.addEventListener('DOMContentLoaded', initialize);
        
        // Sincronizar avatar ap√≥s inicializa√ß√£o
        setTimeout(syncUserAvatar, 1500);
    </script>
</body>
</html>